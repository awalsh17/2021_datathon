---
title: "Some initial exploration"
author: "Alice"
date: "3/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = "asis")
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(gtsummary)
library(readr)
library(ggplot2)
library(dplyr)
```


# Summary
This is just a stream of consciousness exploration of the data and debugging all the data manipulations.
I used the data I had already manipulated and saved locally in the 'aw_process_data.R' script.

```{r message=FALSE}
merged <- readRDS('~/Documents/merged_jat.Rds')
```

## Judge scorecard/summary
Can we filter by judge, then show some dashboard about them with comparisons "other judges".

In the end, we could have some sort of judge search.

You select 1 judge and then can filter by:

- Offense (either high level by statute or search a specific term like "retail theft")
- Defendant demographics
- Time period

We return:

- Number of dockets
- Bail information
- Sentence information
- Social media or news about the judge?

Top 5 judges by year (number of dockets)
```{r}
merged %>% 
  mutate(year = lubridate::year(filing_date)) %>% 
  group_by(year) %>% 
  mutate(judge = forcats::fct_lump_n(judge, n=5))%>% 
  ungroup() %>% 
  filter(judge!="Other") %>% 
  count(year,judge, sort=F) %>% 
  pander::pander()
```


Let's take [Rayford A. Means](https://ballotpedia.org/Rayford_A._Means) as an example. 

This [article](https://digital.olivesoftware.com/Olive/ODN/PhiladelphiaInquirer/shared/ShowArticle.aspx?doc=PHQP%2F2019%2F10%2F27&entity=Ar01701&sk=614449E1&mode=text#) claims that he was sentencing for longer than other judges for retail theft.

Take the case of "retail theft" - there are mutliple descriptions with some sort of retail theft. These could vary a lot, but for now, take anything with "retail theft" in it. Lots of these dockets contain other crimes that might be much more severe. A quick check says that there are some felonies.

```{r}
input <- list()
input$judge <- "Rayford A. Means"
input$statute_title <- NULL
input$grade <- NULL
input$minyear <- 2010
input$maxyear <- 2020
input$search_term <- "retail theft"
input$defendant_age <- NULL
input$defendant_gender <- "Male"
input$defendant_race <- NULL
```

Summarize the search:

```{r}
input %>% as.data.frame() %>% pander::pander()
```


```{r}
# Have not implemented all the searches, just a couple of them to illustrate
if(is.null(input$search_term)) input$search_term <- "*"
if(is.null(input$statute_title)) input$statute_title <- unique(unlist(merged$statute_pt1))
  
  
# Modify the data based on these searches
mydata <- merged %>% 
  mutate(year = lubridate::year(filing_date),
         select_judge = ifelse(judge==input$judge, T, F),
         max_sentence_all = pmax(max_period_days_Probation,max_period_days_Confinement,
                                 na.rm = T)   
  )

mydata$select_searchterm <- tolower(mydata$desc_main) %>% 
  grepl(pattern = tolower(input$search_term), unlist(.))

# Filter the data based on these searches

mydata <- mydata %>% 
  filter(gender == input$defendant_gender,
         select_searchterm,
         year >= input$minyear & year <= input$maxyear,
         any(statute_pt1 %in% input$statute_title))
```

Total dockets from search: `r n_distinct(filter(mydata, select_judge)$docket_id)`

### Total dockets per year
```{r}
mydata %>% 
  ggplot(aes(x=year,fill=select_judge)) + 
  geom_bar(position = "dodge") + 
  labs(title=input$judge,
       subtitle = "Dockets per year") + 
  theme_bw()
```

### Total dockets by max grade of any offense on that docket

```{r}
mydata %>% 
  ggplot(aes(x=max_grade,fill=select_judge)) + 
  geom_bar(position = "dodge") + 
  labs(title=input$judge,
       subtitle = "Dockets per max grade") + 
  theme_bw()
```

### Demographics of defendants
```{r}
mydata %>% 
  ggplot(aes(x=gender,fill=select_judge)) + 
  geom_bar(position = "dodge") + 
  labs(title=input$judge,
       subtitle = "Defendant gender") + 
  theme_bw()
```

```{r}
mydata %>% 
  ggplot(aes(x=race,fill=select_judge)) + 
  geom_bar(position = "dodge") + 
  labs(title=input$judge,
       subtitle = "Defendant race") + 
  theme_bw()
```


### Dispositions
```{r}
mydata %>% 
  tidyr::unnest(disposition) %>% 
  na.omit() %>% 
  ggplot(aes(x=disposition,fill=select_judge)) + 
  geom_bar(position = "dodge") +
  labs(title=input$judge,
       subtitle = "Dispositions") + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle =90, hjust=1,vjust=0.5))
```


```{r}
mydata %>% 
  mutate(included_felony = ifelse(max_grade %in% c("F","F1","F2","F3"), T, F)) %>% 
  ggplot(aes(x=select_judge, group= select_judge, y= max_sentence_all)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0,width=0.2, aes(color = included_felony)) + 
  # facet_wrap(~year) + 
  # scale_y_log10() + 
  labs(title=input$judge,
       x = "Is Rayford A. Means the judge?",
       subtitle = "max sentences (days confinement or probation) for retail theft") + 
  theme_bw()
```

### Bail


```{r}
mydata %>% 
  ggplot(aes(x=any_monetary_bail,fill=select_judge)) + 
  geom_bar(position = "dodge") +
  labs(title=input$judge,
       subtitle = "Bail") + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle =90, hjust=1,vjust=0.5))
```


```{r}
mydata %>% 
  filter(!is.na(initial_set_bail_amount), initial_set_bail_amount>0) %>% 
  ggplot(aes(x=max_grade, group= max_grade, y= initial_set_bail_amount)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0,width=0.2, alpha = 0.25, aes(color=select_judge)) + 
  scale_y_log10() +
  labs(title=input$judge,
       subtitle = "Initial bail total amount by highest grade offense",
       caption = "Note that this excludes $0 bail") + 
  theme_bw()
```

## Other ideas

How many dockets had no bail amount > 0 ? (Could be ROR or nonmonetary)

```{r}
mydata %>% 
  filter(max_bail_amount == 0) %>% 
  count(max_grade, sort=T) %>% 
  pander::pander()
```


The minimum bail per docket ranges from 1 dollar to 100,100,000 dollars in the entire dataset.

```{r}
mydata %>% 
  filter(min_bail_amount>0) %>% 
ggplot( aes(x=max_grade, y= min_bail_amount))+
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0, width=0.15, alpha=0.5) +
  scale_y_log10() +
  labs(title = "Min bail amount when >$0",
       subtitle = "All years") + 
  theme_bw()

```


```{r}
sessionInfo()
```

